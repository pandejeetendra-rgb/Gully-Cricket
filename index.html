<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gully Cricket Quiz ‚Äî High Graphics (No Flicker)</title>
  <style>
    :root{
      --bg:#061022;
      --panel:#0e1a33;
      --ink:#eaf0ff;
      --muted:#b9c6ff;
      --line:rgba(255,255,255,.12);
      --shadow: 0 14px 34px rgba(0,0,0,.42);
      --radius:18px;

      --accent1:#6aa8ff;
      --accent2:#2ee59d;
      --bad:#ff5a7a;
      --warn:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 25% 10%, rgba(106,168,255,.22), transparent 55%),
        radial-gradient(900px 560px at 85% 18%, rgba(46,229,157,.16), transparent 60%),
        radial-gradient(900px 720px at 60% 92%, rgba(255,90,122,.12), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }
    .wrap{max-width:1120px;margin:0 auto;padding:14px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(106,168,255,.95), rgba(46,229,157,.90));
      display:grid;place-items:center;
      color:#061025;font-weight:900;
      box-shadow: var(--shadow);
    }
    .title h1{margin:0;font-size:16px;letter-spacing:.2px}
    .title p{margin:2px 0 0 0;color:var(--muted);font-size:12px}

    .topRight{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:8px 10px;border-radius: 999px;
      color:var(--muted);font-size:12px;
    }
    .pill b{color:var(--ink)}
    .primary,.ghost{
      border:none;cursor:pointer;
      border-radius: 14px;
      padding:10px 12px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .primary{
      background: linear-gradient(135deg, rgba(106,168,255,.95), rgba(46,229,157,.9));
      color:#061025;
    }
    .ghost{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--ink);
    }

    /* Stage: both screens stay mounted, crossfade only (no flicker) */
    .stage{
      position:relative;
      min-height: 600px;
      transform: translateZ(0);
    }
    .screen{
      position:absolute; inset:0;
      opacity:0;
      transform: translateY(6px) scale(.995);
      pointer-events:none;
      transition: opacity .22s ease, transform .22s ease;
      will-change: opacity, transform;
      backface-visibility:hidden;
      transform-style:preserve-3d;
    }
    .screen.show{
      opacity:1;
      transform: translateY(0) scale(1);
      pointer-events:auto;
    }

    .panel{
      background: linear-gradient(180deg, rgba(14,26,51,.95), rgba(9,16,36,.95));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .kicker{color:var(--muted);font-size:12px}
    .big{font-weight:950;letter-spacing:.2px}
    .panel .bd{padding:14px}

    /* Layout */
    .gameLayout{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media (max-width: 980px){ .gameLayout{grid-template-columns:1fr} }

    /* Canvas container */
    .canvasWrap{
      border-radius: 22px;
      border:1px solid var(--line);
      overflow:hidden;
      background: rgba(255,255,255,.03);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      position:relative;
      min-height: 380px;
    }
    canvas{display:block;width:100%;height:100%}

    .scorebox{
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius: 18px;
      padding:12px;
    }
    .scoreTop{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom:10px;
    }
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 999px;
      padding:8px 10px;
      font-size:12px;color:var(--muted);
      display:inline-flex;gap:8px;align-items:center;
    }
    .chip b{color:var(--ink)}
    .ballDots{display:flex;gap:8px;align-items:center}
    .dot{
      width:10px;height:10px;border-radius:99px;
      background: rgba(255,255,255,.14);
      border:1px solid var(--line);
    }
    .dot.on{background: rgba(106,168,255,.90)}
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .stat{
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:10px;
      min-height:64px;
    }
    .stat .lbl{color:var(--muted);font-size:11px}
    .stat .val{font-size:18px;font-weight:950;margin-top:4px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .small{font-size:12px;color:var(--muted)}

    /* Quiz */
    .qcard{
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius: 18px;
      padding:14px;
    }
    .qmeta{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;color:var(--muted);font-size:12px;
    }
    .qtext{font-size:15px;line-height:1.35;font-weight:950;margin-bottom:12px}
    .opts{display:grid;grid-template-columns:1fr;gap:10px}
    .btn{
      width:100%;
      border:none;border-radius: 16px;
      padding:12px 12px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color: var(--ink);
      font-size:14px;text-align:left;
      cursor:pointer;
      transition: transform .05s ease, background .12s ease;
      display:flex;gap:10px;align-items:flex-start;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn:active{transform: scale(.99)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .tag{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background: rgba(106,168,255,.18);
      border:1px solid rgba(106,168,255,.25);
      font-weight:950;flex:0 0 auto;margin-top:1px;
    }
    .btn .txt{flex:1}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:12px}

    .toast{
      margin-top:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding:12px;
      display:none;
    }
    .toast.show{display:block}
    .toast .t{font-weight:950}
    .toast.good .t{color:var(--accent2)}
    .toast.bad .t{color:var(--bad)}
    .toast .m{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.45}
    .toast .m b{color:var(--warn)}

    /* Modal */
    .modal{
      position:fixed;inset:0;background: rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:16px;z-index:50;
    }
    .modal.show{display:flex}
    .modal .box{
      width:min(900px, 96vw);
      background: linear-gradient(180deg, rgba(14,26,51,.98), rgba(9,16,36,.98));
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .box .hd{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modal .box .hd .ttl{font-weight:950}
    .modal .box .bd{padding:14px 16px;color:var(--muted);font-size:13px;line-height:1.55}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media (max-width: 700px){ .grid2{grid-template-columns:1fr} }
    .cardmini{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding:12px;
    }
    .cardmini b{color:var(--ink)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">üèè</div>
      <div class="title">
        <h1>Gully Cricket Quiz ‚Äî High Graphics (No Flicker)</h1>
        <p>MCQ ‚Üí Canvas pitch animation ‚Üí MCQ ‚Ä¢ Bowler deliver, runs, boundary, wicket</p>
      </div>
    </div>
    <div class="topRight">
      <span class="pill">Balls/Over: <b id="bpoTop">6</b></span>
      <button class="ghost" id="howBtn" type="button">How to play</button>
      <button class="primary" id="startBtn" type="button">Start / Restart</button>
    </div>
  </header>

  <div class="stage">
    <!-- QUIZ -->
    <section class="screen show" id="quizScreen">
      <div class="panel">
        <div class="hd">
          <div>
            <div class="kicker">Question Screen</div>
            <div class="big">Answer to play the next ball</div>
          </div>
          <div class="pill">One attempt only</div>
        </div>
        <div class="bd">
          <div class="qcard">
            <div class="qmeta">
              <span id="topicLbl">Topic: ‚Äî</span>
              <span id="qCountLbl">0 / 0</span>
            </div>
            <div class="qtext" id="qText">Press Start to load the first question.</div>

            <div class="opts" id="opts">
              <button class="btn" disabled><span class="tag">A</span><span class="txt">‚Äî</span></button>
              <button class="btn" disabled><span class="tag">B</span><span class="txt">‚Äî</span></button>
              <button class="btn" disabled><span class="tag">C</span><span class="txt">‚Äî</span></button>
              <button class="btn" disabled><span class="tag">D</span><span class="txt">‚Äî</span></button>
            </div>

            <div class="controls">
              <button class="ghost" id="skipBtn" type="button">Skip ball</button>
              <button class="ghost" id="endBtn" type="button">End innings</button>
            </div>

            <div class="toast" id="toast">
              <div class="t" id="toastT">Correct!</div>
              <div class="m" id="toastM">‚Äî</div>
            </div>

            <div class="hr"></div>
            <div class="small">After you answer, the pitch animation will show the outcome, then returns to the next MCQ.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- GAME -->
    <section class="screen" id="gameScreen">
      <div class="panel">
        <div class="hd">
          <div>
            <div class="kicker">Game Screen</div>
            <div class="big">Bowler delivers ‚Üí Bat ‚Üí Run / Boundary / Out</div>
          </div>
          <div class="pill">Auto return to MCQ</div>
        </div>
        <div class="bd">
          <div class="gameLayout">
            <div class="canvasWrap">
              <canvas id="pitch"></canvas>
            </div>

            <div class="scorebox">
              <div class="scoreTop">
                <div class="chip">Over: <b id="overLbl">0</b></div>
                <div class="chip">Ball: <b id="ballLbl">0</b>/<b id="bpoLbl">6</b></div>
                <div class="chip">Wickets: <b id="wktLbl">0</b>/<b id="wktMaxLbl">2</b></div>
                <div class="chip">Runs: <b id="runsLbl">0</b></div>
              </div>
              <div class="ballDots" id="ballDots"></div>

              <div class="stats">
                <div class="stat"><div class="lbl">Accuracy</div><div class="val" id="accLbl">0%</div></div>
                <div class="stat"><div class="lbl">Correct</div><div class="val" id="okLbl">0</div></div>
                <div class="stat"><div class="lbl">Wrong</div><div class="val" id="badLbl">0</div></div>
                <div class="stat"><div class="lbl">Strike Rate</div><div class="val" id="srLbl">0</div></div>
              </div>

              <div class="hr"></div>
              <div class="small" id="gameMsg">Waiting‚Ä¶</div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- HOW TO PLAY -->
<div class="modal" id="modal">
  <div class="box">
    <div class="hd">
      <div class="ttl">How to play</div>
      <button class="ghost" id="closeHow" type="button">Close</button>
    </div>
    <div class="bd">
      <div class="cardmini"><b>Flow:</b> MCQ ‚Üí Canvas cricket animation ‚Üí MCQ.</div>
      <div class="grid2">
        <div class="cardmini"><b>Correct:</b> 1/2 runs (running), 4 (boundary), 6 (sixer).</div>
        <div class="cardmini"><b>Wrong:</b> dot ball or wicket (OUT) for critical mistakes.</div>
        <div class="cardmini"><b>No timer:</b> comfortable for MOOC learners.</div>
        <div class="cardmini"><b>Skip:</b> dot ball.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   QUESTION BANK (from your text)
   ========================= */
const QUESTIONS = [
  { topic:"E-Wallet Basics", q:"An e-wallet is best described as:", choices:[
    "A physical wallet with a chip inside",
    "An electronic application used for online transactions using smartphones or computers",
    "A bank branch counter service",
    "A device used only for printing receipts"
  ], answer:1, explain:"An e-wallet is an electronic application used for e-commerce transactions via phone/computer.", difficulty:1 },

  { topic:"E-Wallet Security Mechanisms", q:"Which mechanisms are mentioned as part of the payment process security for e-wallets?", choices:[
    "Certificate pinning and encryption",
    "Turning off mobile data permanently",
    "Using only public Wi-Fi",
    "Sharing passwords with support staff"
  ], answer:0, explain:"The content mentions certificate pinning and encryption as security mechanisms.", difficulty:2 },

  { topic:"SIM Swap & Impersonation", q:"SIM swap impersonation mainly becomes dangerous because the attacker can:", choices:[
    "Generate OTPs on the duplicate SIM and authorize transactions",
    "Increase battery life of the victim‚Äôs phone",
    "Improve network coverage for the victim",
    "Encrypt the victim‚Äôs phone automatically"
  ], answer:0, explain:"With a duplicate SIM, the fraudster can receive/generate OTPs and complete transactions.", difficulty:3 },

  { topic:"Phishing & Verification", q:"To verify a website‚Äôs authenticity, the content recommends checking:", choices:[
    "The browser‚Äôs digital certificate (padlock/certificates)",
    "Only the website‚Äôs color theme",
    "The number of ads on the page",
    "The time zone shown in the footer"
  ], answer:0, explain:"Verify the site by validating its digital certificate (padlock/certificates in browser).", difficulty:2 },

  { topic:"Malware Prevention", q:"One key prevention against malware attacks is to:", choices:[
    "Keep the wallet software and device software up to date",
    "Install apps only from unknown sources",
    "Disable all updates permanently",
    "Share device passcode with friends"
  ], answer:0, explain:"Updates deliver important security fixes and help keep the environment safer.", difficulty:1 },

  { topic:"Network Safety", q:"Which network practice is recommended for safer e-wallet usage?", choices:[
    "Use only trusted networks and avoid public Wi-Fi",
    "Prefer open public Wi-Fi for convenience",
    "Disable Wi-Fi passwords for easy access",
    "Use any network; encryption is unnecessary"
  ], answer:0, explain:"Use trusted networks; avoid public Wi-Fi; prefer secured Wi-Fi like WPA/WPA2 with strong passwords.", difficulty:2 },

  { topic:"Micro ATM Basics", q:"Micro ATMs are best described as:", choices:[
    "PoS devices that use minimal power and connect to banking servers via GPRS",
    "Desktop computers used only in metro cities",
    "Home routers for Wi-Fi extension",
    "Devices used only for printing passbooks"
  ], answer:0, explain:"Micro ATMs are PoS devices with low power needs connecting via GPRS to banking servers.", difficulty:1 },

  { topic:"POS Data Vulnerabilities", q:"The three key areas of POS data vulnerability highlighted are data:", choices:[
    "In memory, in transit, and at rest",
    "In photos, in songs, and in videos",
    "In chat, in calls, and in games",
    "In weather, in maps, and in calendars"
  ], answer:0, explain:"The text highlights data in memory, data in transit, and data at rest.", difficulty:2 },

  { topic:"Skimming", q:"Skimming refers to:", choices:[
    "Theft of card information using a small device near the card acceptance slot",
    "Legally updating bank records",
    "Changing ATM wallpaper",
    "Compressing files on a device"
  ], answer:0, explain:"Skimming steals card data using a small device near the acceptance slot.", difficulty:2 },

  { topic:"Service Provider Practices", q:"A key best practice for micro ATM service providers is that the device must not:", choices:[
    "Transmit confidential data unencrypted over the network",
    "Use a power adapter",
    "Print mini-statements",
    "Connect to banking servers"
  ], answer:0, explain:"Confidential data must not be transmitted unencrypted on the network.", difficulty:3 },
];

/* =========================
   SETTINGS
   ========================= */
const SETTINGS = {
  ballsPerOver: 6,
  maxWickets: 2,
  wicketChanceEasy: 0.10,
  wicketChanceMed: 0.22,
  wicketChanceHard: 0.40,

  // pacing
  quizConfirmMs: 520,          // tiny confirmation on quiz
  animTotalMs: 2200,           // total game timeline
  explainOnQuizMs: 950,        // show explanation on quiz after returning
};

/* =========================
   STATE + UI
   ========================= */
let state, deck, current, locked=false;

const $ = (id)=>document.getElementById(id);

const quizScreen = $("quizScreen");
const gameScreen = $("gameScreen");

const topicLbl = $("topicLbl");
const qCountLbl = $("qCountLbl");
const qText = $("qText");
const opts = $("opts");
const toast = $("toast");
const toastT = $("toastT");
const toastM = $("toastM");

const overLbl = $("overLbl");
const ballLbl = $("ballLbl");
const bpoLbl  = $("bpoLbl");
const wktLbl  = $("wktLbl");
const wktMaxLbl = $("wktMaxLbl");
const runsLbl = $("runsLbl");
const accLbl = $("accLbl");
const okLbl = $("okLbl");
const badLbl = $("badLbl");
const srLbl = $("srLbl");
const ballDots = $("ballDots");
const gameMsg = $("gameMsg");

$("bpoTop").textContent = SETTINGS.ballsPerOver;
bpoLbl.textContent = SETTINGS.ballsPerOver;
wktMaxLbl.textContent = SETTINGS.maxWickets;

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function makeDeck(){
  deck = shuffle(QUESTIONS.map((q, idx)=>({...q, _id:idx})));
}
function resetState(){
  state = { over:0, ballInOver:0, ballsFaced:0, wickets:0, runs:0, correct:0, wrong:0, asked:0, ended:false };
  locked=false; current=null;
  makeDeck();
  renderDots();
  renderAll();
  setToast(false);
  setQuestionUI(null,0,QUESTIONS.length);
  flipTo("quiz");
}
function renderDots(){
  ballDots.innerHTML="";
  for(let i=0;i<SETTINGS.ballsPerOver;i++){
    const d=document.createElement("div");
    d.className="dot";
    ballDots.appendChild(d);
  }
  setDots();
}
function setDots(){
  [...ballDots.children].forEach((n,i)=>{
    n.className = "dot" + (i < state.ballInOver ? " on":"");
  });
}
function updateDerived(){
  const total = state.correct + state.wrong;
  const acc = total ? Math.round((state.correct/total)*100) : 0;
  const sr  = state.ballsFaced ? Math.round((state.runs/state.ballsFaced)*100) : 0;
  accLbl.textContent = acc + "%";
  okLbl.textContent = state.correct;
  badLbl.textContent = state.wrong;
  srLbl.textContent = sr;
}
function renderAll(){
  overLbl.textContent = state.over;
  ballLbl.textContent = state.ballInOver;
  wktLbl.textContent = state.wickets;
  runsLbl.textContent = state.runs;
  setDots();
  updateDerived();
}

function lockButtons(lock=true){
  locked=lock;
  [...opts.querySelectorAll(".btn")].forEach(b=>b.disabled = lock || state.ended);
  $("skipBtn").disabled = lock || state.ended;
  $("endBtn").disabled = lock || state.ended;
}
function setQuestionUI(q, index, total){
  topicLbl.textContent = "Topic: " + (q?.topic || "‚Äî");
  qCountLbl.textContent = `${index} / ${total}`;
  qText.textContent = q ? q.q : "Press Start to load the first question.";

  const buttons=[...opts.querySelectorAll(".btn")];
  const labels=["A","B","C","D"];
  buttons.forEach((btn,i)=>{
    btn.querySelector(".tag").textContent=labels[i];
    btn.querySelector(".txt").textContent=q ? q.choices[i] : "‚Äî";
    btn.disabled = !q || locked || state.ended;
    btn.onclick = ()=>handleAnswer(i);
  });
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function setToast(show, kind="good", title="", html=""){
  toast.classList.remove("good","bad","show");
  if(!show) return;
  toast.classList.add("show", kind);
  toastT.textContent = title;
  toastM.innerHTML = html;
}
function flipTo(which){
  // no display toggling, only opacity (prevents flicker)
  if(which==="quiz"){
    quizScreen.classList.add("show");
    gameScreen.classList.remove("show");
  }else{
    gameScreen.classList.add("show");
    quizScreen.classList.remove("show");
  }
}

/* scoring */
function difficultyRuns(diff){
  const r=Math.random();
  if(diff<=1) return (r<0.72?1:2);
  if(diff===2) return (r<0.58?2:4);
  return (r<0.55?4:6);
}
function wicketChance(diff){
  if(diff<=1) return SETTINGS.wicketChanceEasy;
  if(diff===2) return SETTINGS.wicketChanceMed;
  return SETTINGS.wicketChanceHard;
}
function advanceBallCounters(){
  state.ballInOver += 1;
  state.ballsFaced += 1;
  if(state.ballInOver >= SETTINGS.ballsPerOver) state.ballInOver = 0;
}

/* =========================
   CANVAS PITCH ENGINE (smooth graphics)
   ========================= */
const canvas = $("pitch");
const ctx = canvas.getContext("2d");

let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
let W=0,H=0;

function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  W = Math.max(320, Math.floor(rect.width));
  H = Math.max(260, Math.floor(rect.height));
  canvas.width  = Math.floor(W * DPR);
  canvas.height = Math.floor(H * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener("resize", ()=>{ resizeCanvas(); });

/* A simple timeline animation controller */
let anim = {
  active:false,
  t0:0,
  duration:SETTINGS.animTotalMs,
  outcome:"DOT", // DOT, WICKET, RUN1, RUN2, FOUR, SIX
  bannerText:"",
  bannerTone:"good",
  runs:0,
  particles:[],
  // positions (normalized 0..1)
  bowlerX: 0.78, bowlerY: 0.66,
  strikerX:0.22, strikerY:0.72,
  nonX:0.48, nonY:0.58,
  ballX:0.78, ballY:0.58,
  ballVisible:false,
  bailPop:0,
};

function lerp(a,b,t){ return a+(b-a)*t; }
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }
function easeInOutQuad(t){ return t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2; }

function addParticles(kind){
  // kind: "confetti" or "spark"
  const count = (kind==="confetti") ? 38 : 18;
  for(let i=0;i<count;i++){
    anim.particles.push({
      x: 0.5 + (Math.random()*0.25-0.125),
      y: 0.20 + (Math.random()*0.08-0.04),
      vx: (Math.random()*0.4-0.2),
      vy: (Math.random()*0.45+0.15),
      r: 2 + Math.random()*4,
      rot: Math.random()*Math.PI,
      vr: (Math.random()*6-3),
      life: 0,
      max: 0.9 + Math.random()*0.5,
      hue: Math.floor(Math.random()*360),
      kind
    });
  }
}

function startAnimation(outcome, runs){
  anim.active = true;
  anim.t0 = performance.now();
  anim.duration = SETTINGS.animTotalMs;
  anim.outcome = outcome;
  anim.runs = runs || 0;
  anim.particles = [];
  anim.ballX = anim.bowlerX;
  anim.ballY = 0.58;
  anim.ballVisible = false;
  anim.bailPop = 0;

  // banner config
  if(outcome==="SIX"){ anim.bannerText="SIX!"; anim.bannerTone="warn"; addParticles("confetti"); }
  else if(outcome==="FOUR"){ anim.bannerText="FOUR!"; anim.bannerTone="warn"; }
  else if(outcome==="RUN1"){ anim.bannerText="1 RUN"; anim.bannerTone="good"; }
  else if(outcome==="RUN2"){ anim.bannerText="2 RUNS"; anim.bannerTone="good"; }
  else if(outcome==="WICKET"){ anim.bannerText="OUT!"; anim.bannerTone="bad"; }
  else { anim.bannerText="DOT BALL"; anim.bannerTone="bad"; }

  requestAnimationFrame(tick);
}

function drawRoundedRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

function drawStadium(){
  // sky gradient
  const sky = ctx.createLinearGradient(0,0,0,H);
  sky.addColorStop(0,"rgba(10,20,45,1)");
  sky.addColorStop(0.55,"rgba(7,16,34,1)");
  sky.addColorStop(1,"rgba(6,12,26,1)");
  ctx.fillStyle = sky;
  ctx.fillRect(0,0,W,H);

  // stadium light glow
  const glow = ctx.createRadialGradient(W*0.2, H*0.12, 10, W*0.2, H*0.12, W*0.45);
  glow.addColorStop(0,"rgba(255,255,255,.12)");
  glow.addColorStop(1,"rgba(255,255,255,0)");
  ctx.fillStyle = glow;
  ctx.fillRect(0,0,W,H);

  const glow2 = ctx.createRadialGradient(W*0.8, H*0.14, 10, W*0.8, H*0.14, W*0.5);
  glow2.addColorStop(0,"rgba(255,255,255,.10)");
  glow2.addColorStop(1,"rgba(255,255,255,0)");
  ctx.fillStyle = glow2;
  ctx.fillRect(0,0,W,H);

  // crowd band
  ctx.globalAlpha = 0.82;
  ctx.fillStyle = "rgba(0,0,0,.32)";
  ctx.fillRect(0,0,W,H*0.22);

  // crowd dots
  ctx.globalAlpha = 0.70;
  for(let i=0;i<150;i++){
    const x = (i/150)*W + (Math.random()*6-3);
    const y = H*0.06 + (Math.random()*H*0.12);
    ctx.fillStyle = `rgba(255,255,255,${0.06 + Math.random()*0.10})`;
    ctx.fillRect(x,y,3,3);
  }
  ctx.globalAlpha = 1;
}

function drawGround(){
  // grass stripes area
  const grassTop = H*0.22;
  const grassH = H*0.78;
  for(let i=0;i<18;i++){
    const x = (i/18)*W;
    const w = W/18 + 1;
    ctx.fillStyle = (i%2===0) ? "rgba(46,229,157,.14)" : "rgba(46,229,157,.08)";
    ctx.fillRect(x, grassTop, w, grassH);
  }
  // vignette
  const vig = ctx.createRadialGradient(W*0.5, H*0.75, 60, W*0.5, H*0.75, W*0.75);
  vig.addColorStop(0,"rgba(0,0,0,0)");
  vig.addColorStop(1,"rgba(0,0,0,.30)");
  ctx.fillStyle = vig;
  ctx.fillRect(0,0,W,H);

  // boundary ellipse
  ctx.save();
  ctx.globalAlpha = 0.55;
  ctx.strokeStyle = "rgba(255,255,255,.22)";
  ctx.setLineDash([6,7]);
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.ellipse(W*0.5, H*0.72, W*0.44, H*0.26, 0, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();
}

function drawPitch(){
  const stripW = W*0.56;
  const stripH = H*0.26;
  const x = W*0.5 - stripW/2;
  const y = H*0.62;
  // pitch strip
  const p = ctx.createLinearGradient(0,y,0,y+stripH);
  p.addColorStop(0,"rgba(255,209,102,.20)");
  p.addColorStop(1,"rgba(255,209,102,.07)");
  ctx.fillStyle = p;
  drawRoundedRect(x,y,stripW,stripH,18);
  ctx.fill();
  ctx.strokeStyle = "rgba(255,209,102,.22)";
  ctx.lineWidth = 1;
  ctx.stroke();

  // creases
  ctx.strokeStyle = "rgba(255,255,255,.22)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x+stripW*0.06, y+stripH*0.28);
  ctx.lineTo(x+stripW*0.94, y+stripH*0.28);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(x+stripW*0.06, y+stripH*0.70);
  ctx.lineTo(x+stripW*0.94, y+stripH*0.70);
  ctx.stroke();

  // faint pitch texture
  ctx.globalAlpha = 0.20;
  for(let i=0;i<18;i++){
    ctx.fillStyle = "rgba(255,255,255,.06)";
    ctx.fillRect(x + (i/18)*stripW, y+6, 2, stripH-12);
  }
  ctx.globalAlpha = 1;
}

function drawWickets(px,py,shake=0,bailPop=0){
  // px,py in pixels at base of stumps
  ctx.save();
  ctx.translate(px + shake, py);
  // shadow
  ctx.globalAlpha = 0.25;
  ctx.fillStyle = "rgba(0,0,0,.65)";
  ctx.beginPath();
  ctx.ellipse(0, 12, 22, 6, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha = 1;

  // stumps
  ctx.lineWidth = 1;
  ctx.strokeStyle = "rgba(255,255,255,.16)";
  const sCol = "rgba(255,255,255,.26)";
  for(let i=-1;i<=1;i++){
    ctx.fillStyle = sCol;
    drawRoundedRect(i*10-4, -56, 8, 60, 6);
    ctx.fill();
    ctx.stroke();
  }

  // bail
  ctx.save();
  ctx.translate(0, -56 - bailPop*18);
  ctx.rotate(bailPop*1.2);
  ctx.fillStyle = "rgba(255,255,255,.22)";
  drawRoundedRect(-18, -6, 36, 8, 6);
  ctx.fill();
  ctx.stroke();
  ctx.restore();

  ctx.restore();
}

function drawPlayer(xN,yN,kit1,kit2,pose){
  // xN,yN normalized (0..1)
  const x = xN * W;
  const y = yN * H;

  // shadow
  ctx.globalAlpha = 0.28;
  ctx.fillStyle = "rgba(0,0,0,.65)";
  ctx.beginPath();
  ctx.ellipse(x, y+12, 20, 6, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha = 1;

  // body
  const bodyGrad = ctx.createLinearGradient(x, y-46, x, y);
  bodyGrad.addColorStop(0, kit1);
  bodyGrad.addColorStop(1, kit2);
  ctx.fillStyle = bodyGrad;
  ctx.strokeStyle = "rgba(255,255,255,.16)";
  ctx.lineWidth = 1;

  drawRoundedRect(x-18, y-46, 36, 42, 14);
  ctx.fill(); ctx.stroke();

  // head
  ctx.fillStyle = "rgba(234,240,255,.92)";
  ctx.beginPath();
  ctx.arc(x, y-56, 10, 0, Math.PI*2);
  ctx.fill();
  ctx.strokeStyle = "rgba(255,255,255,.14)";
  ctx.stroke();

  // legs
  ctx.fillStyle = "rgba(255,255,255,.20)";
  drawRoundedRect(x-14, y-6, 10, 22, 8);
  drawRoundedRect(x+4,  y-6, 10, 22, 8);
  ctx.fill();

  // bat / arm pose
  if(pose === "batIdle" || pose === "batSwing"){
    ctx.save();
    ctx.translate(x+18, y-26);
    const a = (pose==="batSwing") ? -1.0 : 0.35;
    ctx.rotate(a);
    ctx.fillStyle = "rgba(255,209,102,.92)";
    ctx.strokeStyle = "rgba(255,209,102,.22)";
    drawRoundedRect(0, -4, 10, 54, 8);
    ctx.fill(); ctx.stroke();
    ctx.restore();
  }
  if(pose === "bowlRun" || pose === "bowlThrow"){
    // arm
    ctx.save();
    ctx.translate(x+18, y-30);
    const a = (pose==="bowlThrow") ? -1.2 : 0.25;
    ctx.rotate(a);
    ctx.fillStyle = "rgba(234,240,255,.22)";
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    drawRoundedRect(0, -2, 8, 34, 8);
    ctx.fill(); ctx.stroke();
    ctx.restore();
  }
}

function drawBall(xN,yN,alpha=1){
  const x = xN * W;
  const y = yN * H;
  ctx.save();
  ctx.globalAlpha = alpha;
  // trail glow
  const g = ctx.createRadialGradient(x,y,2,x,y,18);
  g.addColorStop(0,"rgba(106,168,255,.35)");
  g.addColorStop(1,"rgba(106,168,255,0)");
  ctx.fillStyle = g;
  ctx.beginPath(); ctx.arc(x,y,18,0,Math.PI*2); ctx.fill();

  // ball
  const b = ctx.createRadialGradient(x-3,y-3,1,x,y,8);
  b.addColorStop(0,"rgba(255,255,255,.95)");
  b.addColorStop(1,"rgba(255,255,255,.25)");
  ctx.fillStyle = b;
  ctx.strokeStyle = "rgba(255,255,255,.18)";
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.restore();
}

function drawBanner(text, tone, t){
  // t is progress 0..1
  const alpha = clamp01(t);
  const scale = 0.96 + 0.04*alpha;
  const w = Math.min(W*0.52, 420);
  const h = 46;
  const x = W*0.5 - (w/2);
  const y = H*0.12;

  ctx.save();
  ctx.globalAlpha = 0.88*alpha;
  ctx.translate(W*0.5, y + h/2);
  ctx.scale(scale, scale);
  ctx.translate(-W*0.5, -(y + h/2));

  ctx.fillStyle = "rgba(9,14,27,.76)";
  ctx.strokeStyle = "rgba(255,255,255,.14)";
  ctx.lineWidth = 1;
  drawRoundedRect(x,y,w,h,999);
  ctx.fill(); ctx.stroke();

  let col = "rgba(46,229,157,1)";
  if(tone==="bad") col = "rgba(255,90,122,1)";
  if(tone==="warn") col = "rgba(255,209,102,1)";
  ctx.fillStyle = col;
  ctx.font = "900 20px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(text, W*0.5, y + h/2 + 1);
  ctx.restore();
}

function drawParticles(dt){
  anim.particles = anim.particles.filter(p=>p.life < p.max);
  for(const p of anim.particles){
    p.life += dt;
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.vy += 0.55 * dt;
    p.rot += p.vr * dt;

    const x = p.x * W;
    const y = p.y * H;
    const a = clamp01(1 - (p.life / p.max));
    ctx.save();
    ctx.globalAlpha = 0.9 * a;
    ctx.translate(x,y);
    ctx.rotate(p.rot);
    ctx.fillStyle = `hsla(${p.hue}, 92%, 70%, ${0.95*a})`;
    ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r);
    ctx.restore();
  }
}

/* Main animation tick */
function tick(now){
  if(!anim.active) return;
  const t = (now - anim.t0);
  const p = clamp01(t / anim.duration);

  // timeline slices:
  // 0.00-0.22 bowler run-up
  // 0.22-0.40 release and ball to bat
  // 0.40-0.55 bat impact
  // 0.55-1.00 outcome (runs/boundary/wicket + runners)
  const p1 = clamp01((p - 0.00) / 0.22);
  const p2 = clamp01((p - 0.22) / 0.18);
  const p3 = clamp01((p - 0.40) / 0.15);
  const p4 = clamp01((p - 0.55) / 0.45);

  // compute positions for characters/ball (normalized)
  const baseBowlerX = 0.78;
  const bowlerRun = easeOutCubic(p1) * 0.06; // moves left
  const bowlerX = baseBowlerX - bowlerRun;
  const bowlerPose = (p < 0.22) ? "bowlRun" : (p < 0.42) ? "bowlThrow" : "bowlThrow";

  const strikerPose = (p < 0.40) ? "batIdle" : (p < 0.55) ? "batSwing" : "batIdle";

  // ball to bat path
  let ballVisible = (p >= 0.22);
  let bx = bowlerX;
  let by = 0.58;

  if(p < 0.22){
    ballVisible = false;
  }else if(p < 0.40){
    const tt = easeOutCubic(p2);
    bx = lerp(bowlerX, 0.30, tt);
    by = lerp(0.58, 0.70, tt);
  }else{
    // post-hit
    const hitX = 0.30, hitY = 0.70;
    if(anim.outcome==="DOT"){
      const tt = easeOutCubic(p4);
      bx = lerp(hitX, 0.44, tt);
      by = lerp(hitY, 0.66, tt);
    }else if(anim.outcome==="WICKET"){
      const tt = easeOutCubic(p4);
      bx = lerp(hitX, 0.40, tt);
      by = lerp(hitY, 0.62, tt);
      anim.bailPop = (p4>0.10) ? Math.min(1, (p4-0.10)/0.30) : 0;
    }else if(anim.outcome==="RUN1" || anim.outcome==="RUN2"){
      const tt = easeOutCubic(p4);
      bx = lerp(hitX, 0.62, tt);
      by = lerp(hitY, 0.64, tt + 0.2*Math.sin(tt*Math.PI));
    }else if(anim.outcome==="FOUR"){
      const tt = easeOutCubic(p4);
      bx = lerp(hitX, 0.88, tt);
      by = lerp(hitY, 0.58, tt) + (0.07*(1 - Math.pow((tt-0.5)/0.5,2))); // small hop
    }else if(anim.outcome==="SIX"){
      const tt = easeOutCubic(p4);
      bx = lerp(hitX, 0.88, tt);
      const arc = 0.22*(1 - Math.pow((tt-0.5)/0.5,2));
      by = lerp(hitY, 0.48, tt) - arc;
    }
  }

  // runners swap animation for 1/2 runs
  let strikerX = 0.22, strikerY = 0.72;
  let nonX = 0.48, nonY = 0.58;

  if(anim.outcome==="RUN1" || anim.outcome==="RUN2"){
    // run happens during p4
    const tt = easeInOutQuad(p4);
    const A0 = {x:0.22,y:0.72}, A1={x:0.48,y:0.58};
    const B0 = {x:0.48,y:0.58}, B1={x:0.22,y:0.72};

    if(anim.outcome==="RUN1"){
      strikerX = lerp(A0.x,A1.x,tt);
      strikerY = lerp(A0.y,A1.y,tt);
      nonX = lerp(B0.x,B1.x,tt);
      nonY = lerp(B0.y,B1.y,tt);
    }else{
      // 2 runs: swap then swap back (two phases)
      if(p4 < 0.55){
        const tA = easeInOutQuad(p4/0.55);
        strikerX = lerp(A0.x,A1.x,tA);
        strikerY = lerp(A0.y,A1.y,tA);
        nonX = lerp(B0.x,B1.x,tA);
        nonY = lerp(B0.y,B1.y,tA);
      }else{
        const tB = easeInOutQuad((p4-0.55)/0.45);
        strikerX = lerp(A1.x,A0.x,tB);
        strikerY = lerp(A1.y,A0.y,tB);
        nonX = lerp(B1.x,B0.x,tB);
        nonY = lerp(B1.y,B0.y,tB);
      }
    }
  }

  // draw frame
  ctx.clearRect(0,0,W,H);
  drawStadium();
  drawGround();
  drawPitch();

  // wickets: batsman end on left, bowler end on right
  const stripBaseY = H*0.62 + H*0.26*0.70;
  drawWickets(W*0.30, stripBaseY, (anim.outcome==="WICKET" ? (Math.sin(p*60)*2*(1-p4)) : 0), anim.bailPop);
  drawWickets(W*0.70, stripBaseY, 0, 0);

  // players
  drawPlayer(strikerX, strikerY, "rgba(106,168,255,.95)", "rgba(106,168,255,.35)", strikerPose);
  drawPlayer(nonX, nonY, "rgba(46,229,157,.90)", "rgba(46,229,157,.30)", "batIdle");
  drawPlayer(bowlerX, 0.66, "rgba(255,90,122,.75)", "rgba(255,90,122,.25)", bowlerPose);

  // ball
  if(ballVisible){
    drawBall(bx, by, 1);
  }

  // banner appears near impact onwards
  if(p > 0.52){
    const tone = (anim.bannerTone==="bad") ? "bad" : (anim.bannerTone==="warn") ? "warn" : "good";
    drawBanner(anim.bannerText, tone, clamp01((p-0.52)/0.18));
  }

  // particles
  const dt = 1/60;
  drawParticles(dt);

  if(p >= 1){
    anim.active = false;
  }else{
    requestAnimationFrame(tick);
  }
}

/* =========================
   GAME FLOW
   ========================= */
function nextBall(){
  if(state.ended) return;

  if(state.wickets >= SETTINGS.maxWickets){
    endInnings("All out (wickets lost).");
    return;
  }
  if(deck.length === 0){
    endInnings("Question bank finished.");
    return;
  }
  if(state.ballInOver === 0){
    state.over += 1;
  }

  current = deck.pop();
  state.asked += 1;

  setQuestionUI(current, state.asked, QUESTIONS.length);
  lockButtons(false);
  setToast(false);
  renderAll();
  flipTo("quiz");
}

function handleAnswer(choiceIndex){
  if(!current || locked || state.ended) return;
  lockButtons(true);

  const correct = (choiceIndex === current.answer);
  const diff = current.difficulty || 2;

  // quick confirm on quiz
  if(correct){
    setToast(true, "good", "Correct", "Now watch the pitch outcome.");
  }else{
    setToast(true, "bad", "Wrong", `<b>Correct:</b> ${escapeHtml(current.choices[current.answer])}`);
  }

  // decide outcome
  let outcome = "DOT";
  let runs = 0;

  if(correct){
    runs = difficultyRuns(diff);
    state.runs += runs;
    state.correct += 1;
    outcome = (runs>=6) ? "SIX" : (runs>=4) ? "FOUR" : (runs===2) ? "RUN2" : "RUN1";
  }else{
    state.wrong += 1;
    const isWicket = Math.random() < wicketChance(diff);
    if(isWicket){
      outcome = "WICKET";
      state.wickets += 1;
    }else{
      outcome = "DOT";
    }
  }

  advanceBallCounters();
  renderAll();

  // move to game screen and run canvas animation
  setTimeout(() => {
    flipTo("game");
    if(outcome==="SIX") addParticles("confetti"); // additional burst
    gameMsg.textContent = (outcome==="WICKET") ? "OUT!" :
                          (outcome==="DOT") ? "DOT BALL" :
                          (outcome==="FOUR") ? "FOUR!" :
                          (outcome==="SIX") ? "SIX!" :
                          (outcome==="RUN2") ? "2 RUNS" : "1 RUN";
    startAnimation(outcome, runs);

    // return to quiz + explanation
    setTimeout(() => {
      flipTo("quiz");
      setToast(true, correct ? "good" : "bad",
        "Explanation",
        `<b>Why:</b> ${escapeHtml(current.explain)}`
      );

      setTimeout(() => {
        setToast(false);
        nextBall();
      }, SETTINGS.explainOnQuizMs);

    }, SETTINGS.animTotalMs);

  }, SETTINGS.quizConfirmMs);
}

function skipBall(){
  if(locked || state.ended) return;
  lockButtons(true);

  state.wrong += 1;
  advanceBallCounters();
  renderAll();

  setToast(true, "bad", "Skipped", "Dot ball. Watch the pitch outcome.");

  setTimeout(() => {
    flipTo("game");
    gameMsg.textContent = "DOT BALL";
    startAnimation("DOT", 0);

    setTimeout(() => {
      flipTo("quiz");
      setToast(false);
      nextBall();
    }, SETTINGS.animTotalMs);

  }, 420);
}

function endInnings(reason){
  state.ended = true;
  lockButtons(true);
  flipTo("quiz");

  const total = state.correct + state.wrong;
  const acc = total ? Math.round((state.correct/total)*100) : 0;

  setQuestionUI(null, state.asked, QUESTIONS.length);
  setToast(true, "good", "Innings Summary",
    `<b>Runs:</b> ${state.runs} &nbsp; <b>Wickets:</b> ${state.wickets}/${SETTINGS.maxWickets}<br/>
     <b>Accuracy:</b> ${acc}% &nbsp; <b>Correct:</b> ${state.correct} &nbsp; <b>Wrong:</b> ${state.wrong}<br/>
     <b>Reason:</b> ${escapeHtml(reason)}`
  );
}

/* =========================
   BUTTONS + MODAL
   ========================= */
$("startBtn").addEventListener("click", () => {
  resetState();
  lockButtons(false);
  nextBall();
});
$("skipBtn").addEventListener("click", skipBall);
$("endBtn").addEventListener("click", () => endInnings("Ended by learner."));

const modal = $("modal");
$("howBtn").addEventListener("click", ()=>modal.classList.add("show"));
$("closeHow").addEventListener("click", ()=>modal.classList.remove("show"));
modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.classList.remove("show"); });

/* =========================
   INIT
   ========================= */
resizeCanvas();
resetState();
lockButtons(true);
flipTo("quiz");
</script>
</body>
</html>
